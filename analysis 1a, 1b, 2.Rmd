---
title: "analysis 1a, 1b, 2"
author: "Brenna Kelly"
date: "2023-10-22"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(ggplot2)
library(regclass)
library(ggridges)
library(quantreg)

```


### Analysis for Objectives 1a, 1b

Objective 1: Identify associations between parity and mean birth weight, independent of maternal characteristics.
a.	Assess relationship between birth weight and parity (adjusting for maternal characteristics).
    - do not use sex or maternal age; these are not extraneous characteristics and will be tested in Objective 2
b.	Assess relationship between birth weight and parity by gestational age (adjusting for maternal characteristics).

# Analysis 1a

```{r}
names(growth_r)
summary(lm(birth_weight ~ parity_c, data = growth_r))
extractAIC(lm(birth_weight ~ parity_c, data = growth_r))
extractAIC(lm(birth_weight ~ parity_cat, data = growth_r))

# race
extractAIC(lm(birth_weight ~ parity_c + race_eth, data = growth_r))
extractAIC(lm(birth_weight ~ parity_c + race_eth_simple, data = growth_r)) # simple categories do not improve fit

# ht, wt
extractAIC(lm(birth_weight ~ parity_c + mom_wt_tx + mom_ht_feet, data = growth_r))
VIF(lm(birth_weight ~ parity_c + mom_wt_tx + mom_ht_feet, data = growth_r)) 
extractAIC(lm(birth_weight ~ parity_c + bmi, data = growth_r)) # bmi is not required for multicollinearity; does not improve fit compared to ht/wt

# race, ht, wt
extractAIC(lm(birth_weight ~ parity + race_eth + mom_weight_previous_c + mom_ht_feet, data = growth_r))

# we have a winner:
lm_1a <- lm(birth_weight ~ parity + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)
summary(lm_1a)
VIF(lm_1a) 

plot(lm_1a)

ggplot(data = growth_r, aes(y = birth_weight, x = parity)) +
  geom_point(alpha = 0.25) +
  theme_minimal() +
  geom_abline(slope = lm_1a$coefficients[["parity"]], 
              intercept = lm_1a$coefficients[["(Intercept)"]]) +
  labs(y = "Birth weight (g)", x = "Parity")

# not normal (qq plot)
plot(lm_1a, which = 2) # plot 2, light tailed qq, especially in the lower tail
# > there is more data located in the lower quantiles (extremes) of the distribution than the center


# influential observation:
plot(lm_1a, which = 4) # plot 4, 
growth_r[names(cooks.distance(lm_1a)[which.max(cooks.distance(lm_1a))][1]), ]
cooks.distance(lm_1a)[which.max(cooks.distance(lm_1a))][1]
# value is only 0.01; this observation probably doesn't have too much influence


## Potential nonlinearity
# the relationship with bw / parity in the data
ggplot(data = growth_r, aes(x = birth_weight, y = parity_c)) +
  geom_density_ridges()
# the fitted relationship with bw / parity in the model (with factor)
#     some strange behavior arises for mothers with more than 9 kids; few observations
lm_1a_1 <- lm(birth_weight ~ parity_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)
ggplot(data = lm_1a, aes(x = lm_1a_1$fitted.values, y = lm_1a_1$model$parity_c)) +
  geom_density_ridges()


# residual diagnostics
mean(lm_1a$residuals)
plot(lm_1a$fitted.values, lm_1a$residuals, xlab='Fitted Values', ylab='Residuals')

growth_r <- growth_r %>%
  filter(!is.na(parity)) |>
  filter(!is.na(mom_weight_previous)) |>
  filter(!is.na(mom_ht_feet))

growth_r$residuals <- lm_1a$residuals

# residuals look heteroskedastic
ggplot(data = growth_r, aes(y = residuals, x = parity)) + 
  geom_point(col = 'blue') + geom_abline(slope = 0)

# formal test
bptest(birth_weight ~ parity + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)
# we reject the null, there is heteroskedasticity




```

*Interpretation of Model 1A:* In women with no prior live births who are White, of average  mean predicted birth weight is 3968.9 g, or 8 lb 12 oz. Based on my limited experience, this is a bit higher than I would expect. Compared to mothers with no previous children, parity generally has a positive effect on birth weight; and (at least for parity less than 10) this is a statistically significant relationship. When parity increases from 0 to 1, birth weight is predicted to increase by 27.97 g, or about 1 oz.

** more interepretatoin

# Analysis 1b

```{r}

extractAIC(lm(birth_weight ~ parity + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))
extractAIC(lm(birth_weight ~ parity + race_eth + gestational_age + mom_wt_tx + mom_ht_feet, data = growth_r))

lm_1b <- lm(birth_weight ~ parity + race_eth + gestational_age_c + mom_wt_tx + mom_ht_feet, data = growth_r)
summary(lm_1b)

ggplot(data = growth_r, aes(y = birth_weight, x = gestational_age_c)) +
  geom_point(alpha = 0.25) +
  theme_minimal() +
  geom_abline(slope = lm_1b$coefficients[["gestational_age_c"]], 
              intercept = lm_1b$coefficients[["(Intercept)"]]) +
  labs(y = "Birth weight (g)", x = "Gestational age")
# overpredicts early gestational age; better fits the majority of data, still over predicting; heteroskedasticity can be seen
bptest(birth_weight ~ parity + race_eth + gestational_age_c + mom_wt_tx + mom_ht_feet, data = growth_r)
# yep, there's heteroskedasticity

ggplot(data = growth_r, aes(y = birth_weight, x = parity)) +
  geom_point(alpha = 0.25) +
  theme_minimal() +
  geom_abline(slope = lm_1a$coefficients[["parity"]], 
              intercept = lm_1a$coefficients[["(Intercept)"]], color = "red") +
  geom_abline(slope = lm_1b$coefficients[["parity"]], 
              intercept = lm_1b$coefficients[["(Intercept)"]], color = "blue")
  labs(y = "Birth weight (g)", x = "Gestational age")
# slightly improved fit for small parity values

names(growth_r)

# not normal (qq plot)
plot(lm_1b, which = 2) # lower light tail improved; upper light tail may be worse

# multicollinearity
VIF(lm_1b) # low

```

*Interpretation of Model 1B:* ..



### Analysis for Objective 2
2.	Determine whether the relationships above differ depending on infant sex or maternal age.

# model selection

```{r}
names(growth_r)

# Model 1B
extractAIC(lm(birth_weight ~ parity + gestational_age_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))
# Model 1B with sex*gest age intx
extractAIC(lm(birth_weight ~ parity + sex*gestational_age_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))
# Model 1B with sex*parity intx
extractAIC(lm(birth_weight ~ sex*parity + gestational_age_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)) # worse than initial 1B
# Model 1B with sex interactions between parity, gest_age
extractAIC(lm(birth_weight ~ sex*parity + sex*gestational_age_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))

extractAIC(lm(birth_weight ~ parity*bmomage_c + gestational_age_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))

extractAIC(lm(birth_weight ~ parity + gestational_age_c*bmomage_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))

extractAIC(lm(birth_weight ~ parity*bmomage_c + sex*gestational_age_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))

extractAIC(lm(birth_weight ~ parity*bmomage_c + sex*gestational_age_c*bmomage_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))

extractAIC(lm(birth_weight ~ sex*parity*bmomage_c + sex*gestational_age_c*bmomage_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)) # lowest



lm_2 <- lm(birth_weight ~ sex*parity*bmomage_c_sc + sex*gestational_age_c*bmomage_c_sc + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)

VIF(lm(birth_weight ~ sex + parity + bmomage_c + gestational_age_c + race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)) # model without interactions has low multicollinearity

summary(lm_2)
summary(growth_r$bmomage)/5
growth_r$bmomage_c_sc <- (growth_r$bmomage / 5) - mean((growth_r$bmomage / 5), na.rm = TRUE)

```


# tests

```{r}

# see interaction plot code

```






### Analysis for Objective 3
3.	Create growth curves as a function of gestational age, stratified by infant sex; describe this curve using quantiles (.10, .25, .50, .75, .90). 

```{r}

cuts <- quantile(growth_r$gestational_age_c, c(0.10, 0.25, 0.50, 0.75, 0.90))[1:5]

extractAIC(lm(birth_weight ~ ns(gestational_age_c, 
                             df = 8) + sex*parity*bmomage_c_sc + 
             race_eth + mom_wt_tx + mom_ht_feet, data = growth_r))
lm_3_s <- lm(birth_weight ~ ns(gestational_age_c, 
                             df = 4) + sex*parity*bmomage_c_sc + 
             race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)
summary(lm_3_s)

plot(birth_weight ~ gestational_age_c, data = growth_r, pch = 16, main = "Plot") 
abline(rq(birth_weight ~ poly(gestational_age_c, 3)*sex, data = growth_r), col = "blue", lty = 2)
summary(rq(birth_weight ~ poly(gestational_age_c, 3)*sex, data = growth_r))


ggplot(growth_r, aes(gestational_age_c, birth_weight)) +
  geom_point(size=1, colour="grey70") +
  geom_quantile(quantiles=cuts, formula = y ~ poly(x, 3), colour="red") +
  geom_smooth(method='lm', formula=y ~ poly(x,3), colour="blue", 
              se=FALSE, linetype="11") +
  theme_classic()

### spline
cubic_spline = rq(birth_weight ~ bs(gestational_age_c, knots = cuts) + sex + 
                    parity + bmomage_c + race_eth + mom_wt_tx + 
                    mom_ht_feet, data = growth_r)
summary(cubic_spline)
extractAIC(cubic_spline)
cubic_spline = rq(birth_weight ~ bs(gestational_age_c, knots = cuts), data = growth_r)
growth_r_2 = mutate(growth_r, smooth = fitted(cubic_spline))

growth_r_2 = mutate(growth_r[which(growth_r$sex == "female"), ], smooth = fitted(cubic_spline))
growth_r_3 = mutate(growth_r[which(growth_r$sex == "male"), ], smooth = fitted(cubic_spline))
male <- predict(cubic_spline, growth_r[which(growth_r$sex == "male"), ])
female <- predict(cubic_spline, growth_r[which(growth_r$sex == "female"), ])
test <- cbind(male, growth_r[which(growth_r$sex == "male"), ])
test_2 <- cbind(female, growth_r[which(growth_r$sex == "female"), ])
head(test)
summary(male[1:20153])

ggplot(growth_r, aes(gestational_age_c, birth_weight)) + 
  labs(x = "Experience in year", y = "Weekly wage")+
  #geom_point(col = "slategrey", alpha = 0.25) +
  geom_point(data = test, col = "red", alpha = 0.15) +
  geom_point(data = test_2, col = "blue", alpha = 0.15) +
  geom_line(data = test, aes(gestational_age_c, male), col = "red") + 
  geom_line(data = test_2, aes(gestational_age_c, female), col = "blue") +
  ggtitle("Cubic regression spline model")
  

growth_r_2 = mutate(growth_r, smooth = fitted(cubic_spline))
ggplot(growth_r_2, aes(gestational_age_c, birth_weight)) + 
  labs(x = "Experience in year", y = "Weekly wage")+
  geom_point(col = "slategrey", alpha = 0.25) +
  geom_line(aes(gestational_age_c, smooth), col = "red") + 
  ggtitle("Cubic regression spline model")

summary(cubic_spline)

library(quantregGrowth)
o <- gcrq(birth_weight ~ ps(gestational_age_c) + sex, data = growth_r)
plot(o, term=2)
plot(o, res=TRUE, col=-1)
summary(o)
AIC(o)
charts(o, k=c(10,10.5,11,16,17))

library(quantreg)
quantiles <- rq(birth_weight ~ gestational_age_c + sex + parity + bmomage_c + race_eth + mom_wt_tx + 
                  mom_ht_feet, data = growth_r, tau = c(0.1, 0.25, 0.5, 0.75, 0.9))
summary(quantiles)
AIC(quantiles)
plot(summary(quantiles), mar=c(0.5,2,2,2))
  
# Plot 
plot(birth_weight ~ gestational_age_c, data = growth_r, pch = 16, main = "Plot") 
abline(lm(birth_weight ~ gestational_age_c, data = growth_r), col = "red", lty = 2) 
abline(rq(birth_weight ~ gestational_age_c, data = growth_r), col = "blue", lty = 2)


plot(lm_3_s, which = 2)
lm_3_s$coefficients
fit <- cbind(str(lm_3_s$fitted.values),
             lm_3_s$model$`ns(gestational_age_c, df = 4)`)
fit <- data.frame(fit)
plot(fit$X1, fit$X4)


ggplot(growth_r, aes(x = gestational_age_c, y = birth_weight)) + 
  geom_point() +
  labs(x = "Gestation", y = "Birth weight") +
  stat_quantile(aes(color = "L2 Regression"), geom = "smooth", method = "rq", 
                quantiles = c(0.10, 0.25, 0.50, 0.75, 0.90),
                formula = y ~ splines::ns(x,df=3))
  stat_smooth(aes(color = "LS Regression"), geom = "smooth", method = "lm", se = FALSE,
              formula = y ~ splines::ns(x, df = 4))




lm_3 <- lm(birth_weight ~ ns(gestational_age_c, 
                             knots = cuts) + sex*parity*bmomage_c_sc + 
             race_eth + mom_wt_tx + mom_ht_feet, data = growth_r)
summary(lm_3)

ggplot(data = growth_r, aes(y = birth_weight, x = gestational_age_c)) +
  geom_point(alpha = 0.25) +
  theme_minimal() +
  stat_smooth(method = lm, formula = birth_weight ~ ns(gestational_age_c, knots = cuts) + 
    sex * parity * bmomage_c_sc + race_eth + mom_wt_tx + mom_ht_feet, se = FALSE)
  geom_abline(slope = lm_1a$coefficients[["parity"]], 
              intercept = lm_1a$coefficients[["(Intercept)"]], color = "red") +
  geom_abline(slope = lm_1b$coefficients[["parity"]], 
              intercept = lm_1b$coefficients[["(Intercept)"]], color = "blue")
  labs(y = "Birth weight (g)", x = "Gestational age")

lm_3$call

ggplot(countries,aes(x=gdpPercap,y=lifeExp))+geom_point()+
  labs(x="GDP Per Capita",y="Life Expectancy (Yrs)") +
  stat_smooth(aes(color="LS Regression"),geom="smooth",method="lm",se=FALSE,
              formula=y~ splines::ns(x,df=3))

agelims <- range(growth_r$gestational_age_c)
#Generating Test Data
age.grid <- seq(from = agelims[1], to = agelims[2])

predict(lm_3, gestational_age_c = age.grid)
length(predict(lm_3, gestational_age_c = age.grid))

predict(lm_3, list(age.grid))

age.grid
length(predict(lm_3, gestational_age_c = age.grid))


lm_3_s <- lm(birth_weight ~ ns(gestational_age_c, 
                               knots = cuts), data = growth_r)

extractAIC(lm(birth_weight ~ ns(gestational_age_c, 
                               knots = cuts), data = growth_r))
extractAIC(lm(birth_weight ~ ns(gestational_age_c, 
                               df = 8), data = growth_r))
lm_3_s <- lm(birth_weight ~ ns(gestational_age_c, 
                               df = 8), data = growth_r)

summary(lm_3_s)
#inv2lims<-range(clothingSinv2)
#inv2.grid<-seq(from=inv2lims [1],to=inv2lims [2])
pred <- predict(lm_3_s, newdata = list(gestational_age_c = age.grid), se = T)

plot(growth_r$gestational_age_c, growth_r$birth_weight, col = "grey",
     xlab ="gestational_age_c", ylab="birth_weight")
lines(age.grid, pred$fit, col = 'red', lwd = 3)


lines(age.grid, lm_3_s$fitted.values, col='red', lwd=3)
lines(age.grid, predict(lm_3_s))

predict(lm_3_s, gestational_age_c = age.grid[1])

abline(v = cuts,lty=2,col="darkgreen")
#lines(lm_3, col="red", lwd=2)
points(age.grid, predict(lm_3, gestational_age_c = age.grid), col="darkgreen", lwd=2, type="l")
#adding cutpoints
abline(v = cuts, lty=2, col="darkgreen")

```





